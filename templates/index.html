<!DOCTYPE html>
<html>
<head>
    <title>Business Leadership Interview Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
        .card { border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 1100px; margin: 20px auto; }
        .btn-gen { background: linear-gradient(45deg, #FF6B6B, #4ECDC4); border: none; padding: 12px 30px; font-weight: bold; color: white; }
        .btn-gen:hover { transform: scale(1.02); transition: 0.2s; }
        .q-card { background: white; border-left: 5px solid #4ECDC4; padding: 15px; margin: 10px 0; border-radius: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .q-card.theory { border-left-color: #5E60CE; }
        .q-card.practical { border-left-color: #FF6B6B; }
        .progress-section { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .status-text { font-size: 1rem; color: #555; margin-bottom: 15px; }
        .difficulty-badge { display: inline-block; padding: 8px 15px; margin: 5px; border-radius: 20px; cursor: pointer; transition: all 0.3s; user-select: none; }
        .difficulty-badge.active { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .beginner { background: #28a745; color: white; }
        .intermediate { background: #ffc107; color: #000; }
        .advanced { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h1 class="text-center mb-2" style="color: #1e3c72;">
                <i class="fas fa-briefcase"></i> Business Leadership Interview Generator
            </h1>
            <p class="text-center text-muted mb-4">For experienced leaders | Theory + Practical | RAG-powered</p>
            
            <div id="form">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Topic *</strong></label>
                        <input type="text" class="form-control" id="topic" placeholder="e.g., Digital Transformation" autofocus>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Number of Questions *</strong></label>
                        <input type="number" class="form-control" id="totalQuestions" min="1" max="100" value="20">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Difficulty Levels *</strong></label>
                    <div>
                        <div class="difficulty-badge beginner active" onclick="toggleDifficulty('Beginner')" id="badge-Beginner">
                            <i class="fas fa-check"></i> Beginner
                        </div>
                        <div class="difficulty-badge intermediate active" onclick="toggleDifficulty('Intermediate')" id="badge-Intermediate">
                            <i class="fas fa-check"></i> Intermediate
                        </div>
                        <div class="difficulty-badge advanced active" onclick="toggleDifficulty('Advanced')" id="badge-Advanced">
                            <i class="fas fa-check"></i> Advanced
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Gemini API Key *</strong></label>
                        <input type="password" class="form-control" id="apiKey">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Firecrawl Key (Optional)</strong></label>
                        <input type="password" class="form-control" id="firecrawlKey" placeholder="For current content">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Balance: Theory vs Practical</strong></label>
                    <input type="range" class="form-range" id="balanceSlider" min="0" max="100" value="50" oninput="updateBalance()">
                    <div class="d-flex justify-content-between">
                        <small>üéì Theory</small>
                        <small id="balanceLabel">50% Theory | 50% Practical</small>
                        <small>üíº Practical</small>
                    </div>
                </div>
                
                <button class="btn btn-gen btn-lg w-100" onclick="startGeneration()">
                    <i class="fas fa-rocket"></i> Generate Leadership Questions
                </button>
            </div>
            
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="status-text" id="statusText">
                    <i class="fas fa-spinner fa-spin"></i> Starting...
                </div>
                <div class="progress" style="height: 35px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progressBar" style="width: 0%; font-size: 16px; font-weight: bold;">
                        0%
                    </div>
                </div>
                <div class="mt-2" id="timer">Time: 0s</div>
            </div>
            
            <div id="questionsContainer"></div>
            
            <div id="downloadSection" style="display: none;" class="text-center mt-4">
                <div class="alert alert-success">
                    <strong><i class="fas fa-check-circle"></i> Complete!</strong><br>
                    <span id="finalStats"></span>
                </div>
                <button class="btn btn-success btn-lg me-2" onclick="downloadPDF()">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="btn btn-outline-secondary btn-lg" onclick="location.reload()">
                    <i class="fas fa-redo"></i> New
                </button>
            </div>
            
            <div id="errorSection" style="display: none;" class="alert alert-danger mt-4">
                <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong>
                <span id="errorMsg"></span>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let currentQuestions = {};
        let currentTopic = '';
        let startTime = null;
        let timerInterval = null;
        let selectedDifficulties = new Set(['Beginner', 'Intermediate', 'Advanced']);
        let currentDifficultyLevels = [];

        function toggleDifficulty(level) {
            const badge = document.getElementById(`badge-${level}`);
            
            if (selectedDifficulties.has(level)) {
                if (selectedDifficulties.size === 1) {
                    alert('At least one difficulty must be selected');
                    return;
                }
                selectedDifficulties.delete(level);
                badge.classList.remove('active');
                badge.innerHTML = level;
            } else {
                selectedDifficulties.add(level);
                badge.classList.add('active');
                badge.innerHTML = '<i class="fas fa-check"></i> ' + level;
            }
        }

        function updateBalance() {
            const value = document.getElementById('balanceSlider').value;
            document.getElementById('balanceLabel').textContent = `${value}% Theory | ${100-value}% Practical`;
        }

        function startGeneration() {
            const topic = document.getElementById('topic').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const firecrawlKey = document.getElementById('firecrawlKey').value.trim();
            const totalQuestions = parseInt(document.getElementById('totalQuestions').value);
            const balanceValue = parseInt(document.getElementById('balanceSlider').value) / 100;
            
            if (!topic || !apiKey) {
                alert('Please enter topic and Gemini API key');
                return;
            }
            
            if (isNaN(totalQuestions) || totalQuestions < 1 || totalQuestions > 100) {
                alert('Questions: 1-100');
                return;
            }
            
            currentTopic = topic;
            currentDifficultyLevels = Array.from(selectedDifficulties);
            
            document.getElementById('form').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            
            currentQuestions = {};
            currentDifficultyLevels.forEach(d => currentQuestions[d] = []);
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 100);
            
            fetch('/generate_stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    topic, 
                    api_key: apiKey,
                    firecrawl_key: firecrawlKey,
                    total_questions: totalQuestions,
                    difficulty_levels: currentDifficultyLevels,
                    balance_ratio: balanceValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    connectToStream(data.stream_id, apiKey, firecrawlKey);
                } else {
                    showError(data.error || 'Failed');
                }
            })
            .catch(error => showError('Network error: ' + error.message));
        }

        function connectToStream(streamId) {
            eventSource = new EventSource(`/stream/${streamId}`);
            
            eventSource.onmessage = function(event) {
                const update = JSON.parse(event.data);
                handleUpdate(update);
            };
            
            eventSource.onerror = function() {
                if (eventSource) eventSource.close();
            };
        }

        function handleUpdate(update) {
            const message = update.message;
            const data = update.data || {};
            
            if (message !== 'ping') {
                let icon = '<i class="fas fa-cog fa-spin"></i>';
                if (message.includes('‚úÖ')) icon = '<i class="fas fa-check"></i>';
                if (message.includes('üîç')) icon = '<i class="fas fa-search"></i>';
                
                document.getElementById('statusText').innerHTML = `${icon} ${message}`;
            }
            
            if (data.progress !== undefined) {
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
            }
            
            if (data.stage === 'question_complete' && data.question) {
                addQuestion(data.difficulty, data.question);
                currentQuestions[data.difficulty].push(data.question);
            }
            
            if (message === 'COMPLETE') {
                if (eventSource) eventSource.close();
                clearInterval(timerInterval);
                showComplete(data);
            }
            
            if (message.startsWith('ERROR')) {
                if (eventSource) eventSource.close();
                clearInterval(timerInterval);
                showError(message);
            }
        }

        function addQuestion(difficulty, questionData) {
            const container = document.getElementById('questionsContainer');
            
            let section = document.getElementById(`section-${difficulty}`);
            if (!section) {
                section = document.createElement('div');
                section.id = `section-${difficulty}`;
                section.innerHTML = `
                    <h5 class="mt-4 mb-3">
                        <span class="badge ${difficulty.toLowerCase()}" style="font-size: 1rem;">
                            ${difficulty}
                        </span>
                    </h5>
                    <div id="questions-${difficulty}"></div>
                `;
                container.appendChild(section);
            }
            
            const questionsDiv = document.getElementById(`questions-${difficulty}`);
            const card = document.createElement('div');
            const qType = questionData.type || 'general';
            card.className = `q-card ${qType}`;
            
            const typeIcon = qType === 'theory' ? 'üéì Theory' : 'üíº Practical';
            
            card.innerHTML = `
                <div style="color: #999; font-size: 0.85rem; margin-bottom: 5px;">
                    ${typeIcon}
                </div>
                <div style="font-weight: 600; color: #1e3c72; margin-bottom: 10px;">
                    ${questionData.question}
                </div>
                <div style="color: #555; line-height: 1.6;">
                    <strong>Answer:</strong> ${questionData.answer}
                </div>
            `;
            questionsDiv.appendChild(card);
            
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateTimer() {
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer').textContent = `Time: ${elapsed}s`;
        }

        function showComplete(data) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'block';
            
            const total = data.total || 0;
            const time = data.generation_time || 0;
            
            document.getElementById('finalStats').innerHTML = `
                ${total} questions in ${time.toFixed(1)}s
            `;
        }

        function downloadPDF() {
            const btn = event.target;
            const origText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;
            
            const pdfStart = Date.now();
            
            fetch('/download_pdf', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    topic: currentTopic,
                    context: '',
                    questions: currentQuestions,
                    difficulty_levels: currentDifficultyLevels,
                    api_key: document.getElementById('apiKey').value
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const pdfTime = ((Date.now() - pdfStart) / 1000).toFixed(1);
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentTopic.replace(/\s+/g, '_') + '.pdf';
                a.click();
                
                btn.innerHTML = `<i class="fas fa-check"></i> Downloaded (${pdfTime}s)`;
                setTimeout(() => {
                    btn.innerHTML = origText;
                    btn.disabled = false;
                }, 3000);
            })
            .catch(e => {
                alert('PDF failed');
                btn.innerHTML = origText;
                btn.disabled = false;
            });
        }

        function showError(msg) {
            clearInterval(timerInterval);
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMsg').textContent = msg;
            document.getElementById('form').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('topic').focus();
        });
    </script>
</body>
</html>
